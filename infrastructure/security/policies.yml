# PSM Enterprise - Security Policies
# Layer 4: Security (Encryption, Authentication)

apiVersion: security.psm/v1
kind: SecurityPolicy
metadata:
  name: psm-enterprise-security

spec:
  # Authentication
  authentication:
    providers:
      - name: jwt
        issuer: "https://purplesquirrel.media"
        audience: "psm-api"
        algorithms:
          - RS256
          - HS256

      - name: api-key
        header: "X-API-Key"
        query: "api_key"

    exemptPaths:
      - /health
      - /api/status
      - /public/*

  # Encryption
  encryption:
    atRest:
      enabled: true
      algorithm: AES-256-GCM

    inTransit:
      minTlsVersion: "1.2"
      preferredTlsVersion: "1.3"
      cipherSuites:
        - TLS_AES_256_GCM_SHA384
        - TLS_CHACHA20_POLY1305_SHA256
        - TLS_AES_128_GCM_SHA256

  # Rate Limiting
  rateLimiting:
    global:
      requestsPerSecond: 100
      burstSize: 200

    perUser:
      requestsPerMinute: 60
      burstSize: 10

    perEndpoint:
      "/api/ai/*":
        requestsPerMinute: 20
      "/api/process":
        requestsPerMinute: 10

  # IP Allowlist/Blocklist
  ipPolicies:
    allowlist:
      enabled: false
    blocklist:
      enabled: true
      ips: []

  # CORS
  cors:
    allowOrigins:
      - "https://purplesquirrel.media"
      - "https://*.purplesquirrel.media"
      - "http://localhost:*"
    allowMethods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS
    allowHeaders:
      - Authorization
      - Content-Type
      - X-API-Key
    maxAge: 86400

  # Content Security Policy
  csp:
    defaultSrc: ["'self'"]
    scriptSrc: ["'self'", "'unsafe-inline'", "https://cdn.jsdelivr.net"]
    styleSrc: ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"]
    imgSrc: ["'self'", "data:", "https:"]
    fontSrc: ["'self'", "https://fonts.gstatic.com"]
    connectSrc: ["'self'", "https://api.purplesquirrel.media", "wss:"]

  # Secrets Management
  secrets:
    provider: "environment"  # or: vault, aws-secrets-manager, azure-keyvault
    rotation:
      enabled: true
      intervalDays: 90

    required:
      - AZURE_VISION_KEY
      - AZURE_SPEECH_KEY
      - SOLANA_TREASURY_KEY

  # Audit Logging
  audit:
    enabled: true
    events:
      - authentication
      - authorization
      - dataAccess
      - configChange
    retention:
      days: 90
    destination:
      type: file
      path: /var/log/psm/audit.log
